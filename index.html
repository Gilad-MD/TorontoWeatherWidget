<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Toronto Weather + Daylight Dial</title>
  <meta name="description" content="Dark-mode weather tile for Toronto with live conditions, hourly mini-forecast, and a daylight dial. Notion-ready, single file.">
  <style>
    :root{
      --bg-1:#0b1020; --bg-2:#0b1228; --card:#0f1426e6; --text:#e5e7eb; --muted:#a1a1aa; --accent:#22d3ee;
      --shadow: 0 10px 30px rgba(0,0,0,.5), inset 0 0 0 1px rgba(255,255,255,.06);
      --radius:22px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Arial; color:var(--text);
      background:radial-gradient(1200px 600px at 0% -10%, rgba(34,211,238,.09), transparent 60%),
                 radial-gradient(800px 500px at 100% -20%, rgba(99,102,241,.10), transparent 50%),
                 linear-gradient(180deg,var(--bg-1),var(--bg-2));
      display:flex; align-items:center; justify-content:center; padding:24px;}
    .wrap{width:100%; max-width:980px}
    .card{position:relative; border-radius:var(--radius); background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.01)), var(--card); box-shadow:var(--shadow); padding:22px}
    header{display:flex; justify-content:space-between; align-items:center; gap:12px}
    .title{display:flex; align-items:center; gap:10px; font-weight:800; letter-spacing:.2px; font-size:clamp(18px,2.3vw,24px)}
    .dot{width:10px; height:10px; border-radius:999px; background:var(--accent); box-shadow:0 0 24px var(--accent)}
    .badges{display:flex; gap:8px; flex-wrap:wrap}
    .badge{border:1px solid rgba(255,255,255,.1); background:rgba(255,255,255,.04); color:var(--muted); padding:6px 10px; border-radius:999px; font-size:12px}

    .grid{display:grid; grid-template-columns: 1.2fr .8fr; gap:16px; margin-top:12px}
    @media (max-width:860px){ .grid{grid-template-columns:1fr} }

    .left{border-radius:18px; padding:16px 18px; background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,0)); box-shadow:var(--shadow)}
    .right{border-radius:18px; padding:16px 18px; background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,0)); box-shadow:var(--shadow)}

    .current{display:flex; align-items:center; gap:14px}
    .icon{width:62px; height:62px}
    .temp{font-variant-numeric:tabular-nums; font-weight:800; font-size:clamp(40px,8vw,68px); letter-spacing:-1.5px}
    .unit{font-size:16px; color:var(--muted); font-weight:700}
    .desc{color:var(--muted); font-size:14px}

    .mini{display:grid; grid-template-columns: repeat(6, 1fr); gap:8px; margin-top:12px}
    .chip{border-radius:14px; padding:8px; background:rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.08); text-align:center}
    .chip .t{font-size:12px; color:var(--muted)}
    .chip .v{font-variant-numeric:tabular-nums; font-weight:700; margin-top:4px}

    .dial{display:flex; flex-direction:column; align-items:center}
    svg{display:block}
    .times{display:flex; justify-content:space-between; width:100%; margin-top:10px; font-size:12px; color:var(--muted)}
    .sub{margin-top:10px; font-size:12px; color:var(--muted)}
    .btn{cursor:pointer}

    .spacer{height:4px}
  </style>
</head>
<body>
  <main class="wrap">
    <section class="card" role="group" aria-labelledby="heading">
      <header>
        <div class="title"><span class="dot" aria-hidden="true"></span><span id="heading">Toronto Weather + Daylight</span></div>
        <div class="badges">
          <div class="badge" id="updated">—</div>
          <div class="badge btn" id="toggleUnit" title="Toggle °C/°F">°C</div>
        </div>
      </header>

      <div class="grid">
        <div class="left">
          <div class="current">
            <div class="icon" id="bigIcon" aria-hidden="true"></div>
            <div>
              <div class="temp"><span id="temp">—</span><span class="unit" id="unit">°C</span></div>
              <div class="desc" id="desc">Loading…</div>
            </div>
          </div>
          <div class="mini" id="mini"></div>
        </div>
        <div class="right">
          <div class="dial">
            <!-- Responsive daylight dial (SVG) -->
            <svg id="dial" viewBox="0 0 220 140" width="100%" height="auto" role="img" aria-label="Daylight dial">
              <!-- sky gradient -->
              <defs>
                <linearGradient id="sky" x1="0" y1="0" x2="0" y2="1">
                  <stop offset="0%" stop-color="#1e293b"/>
                  <stop offset="100%" stop-color="#0b1228"/>
                </linearGradient>
                <linearGradient id="horizon" x1="0" y1="0" x2="0" y2="1">
                  <stop offset="0%" stop-color="rgba(34,211,238,.25)"/>
                  <stop offset="100%" stop-color="rgba(34,211,238,.0)"/>
                </linearGradient>
                <filter id="glow" x="-50%" y="-50%" width="200%" height="200%">
                  <feGaussianBlur stdDeviation="4" result="b"/>
                  <feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge>
                </filter>
              </defs>
              <rect x="0" y="0" width="220" height="140" fill="url(#sky)" rx="16"/>
              <!-- semicircle path -->
              <path id="arc" d="M20,120 A90,90 0 0 1 200,120" fill="none" stroke="rgba(255,255,255,.1)" stroke-width="2"/>
              <!-- daylight fill -->
              <path id="dayFill" d="" fill="url(#horizon)"/>
              <!-- sun/moon -->
              <circle id="sun" cx="20" cy="120" r="6" fill="#fde68a" filter="url(#glow)"/>
              <circle id="moon" cx="20" cy="120" r="5" fill="#e5e7eb" opacity="0.0"/>
              <!-- ticks -->
              <g id="ticks"></g>
            </svg>
            <div class="times"><span id="sunrise">—</span><span id="sunset">—</span></div>
            <div class="sub" id="summary">—</div>
          </div>
        </div>
      </div>
      <div class="spacer"></div>
    </section>
  </main>

  <script>
  (function(){
    const $ = s => document.querySelector(s);
    const params = new URLSearchParams(location.search);
    const safe = (s,f='')=>{try{ s=(s??'').toString().slice(0,120); return s.replace(/[<>]/g,'')||f }catch{ return f }};

    // Defaults (Toronto downtown)
    let lat = parseFloat(params.get('lat')||'43.6532');
    let lon = parseFloat(params.get('lon')||'-79.3832');
    const city = safe(params.get('city'),'Toronto');
    const accent = safe(params.get('accent'),''); if(accent) document.documentElement.style.setProperty('--accent',accent);
    let unit = (params.get('unit')||'metric').toLowerCase(); // metric/imperial
    const refreshMin = Math.max(2, parseInt(params.get('refresh')||'5')); // weather refresh (minutes)

    $('#heading').textContent = `${city} Weather + Daylight`;
    $('#unit').textContent = unit==='imperial' ? '°F':'°C';
    $('#toggleUnit').textContent = unit==='imperial' ? '°F':'°C';

    const tz = 'America/Toronto'; // keep times in Toronto time

    const WMO = {
      0:['Clear','sun'], 1:['Mainly clear','sun'], 2:['Partly cloudy','cloud-sun'], 3:['Overcast','cloud'],
      45:['Fog','fog'], 48:['Rime fog','fog'],
      51:['Drizzle','drizzle'], 53:['Drizzle','drizzle'], 55:['Drizzle','drizzle'],
      56:['Freezing drizzle','sleet'], 57:['Freezing drizzle','sleet'],
      61:['Rain','rain'], 63:['Rain','rain'], 65:['Heavy rain','rain'],
      66:['Freezing rain','sleet'], 67:['Freezing rain','sleet'],
      71:['Snow','snow'], 73:['Snow','snow'], 75:['Heavy snow','snow'],
      77:['Snow grains','snow'], 80:['Showers','rain'], 81:['Showers','rain'], 82:['Violent showers','rain'],
      85:['Snow showers','snow'], 86:['Snow showers','snow'],
      95:['Thunderstorm','storm'], 96:['Thunder + hail','storm'], 99:['Thunder + hail','storm']
    };

    function iconSVG(kind, size=62){
      const stroke = 'rgba(255,255,255,.9)';
      const fill = 'rgba(255,255,255,.15)';
      const s = size; const c = (p)=>`stroke:${stroke};stroke-width:3;stroke-linecap:round;stroke-linejoin:round;fill:none`;
      const sun = `<g><circle cx="31" cy="31" r="12" fill="#fde68a"/><g ${''}><line x1="31" y1="4" x2="31" y2="14" style="${c()}"/><line x1="31" y1="48" x2="31" y2="58" style="${c()}"/><line x1="4" y1="31" x2="14" y2="31" style="${c()}"/><line x1="48" y1="31" x2="58" y2="31" style="${c()}"/><line x1="12" y1="12" x2="18" y2="18" style="${c()}"/><line x1="44" y1="44" x2="50" y2="50" style="${c()}"/><line x1="12" y1="50" x2="18" y2="44" style="${c()}"/><line x1="44" y1="18" x2="50" y2="12" style="${c()}"/></g></g>`;
      const cloud = `<g><ellipse cx="36" cy="38" rx="20" ry="12" fill="${fill}"/><ellipse cx="24" cy="40" rx="14" ry="10" fill="${fill}"/></g>`;
      const rain = `${cloud}<g style="${c()}"><line x1="24" y1="50" x2="20" y2="60"/><line x1="36" y1="50" x2="32" y2="60"/><line x1="48" y1="50" x2="44" y2="60"/></g>`;
      const drizzle = `${cloud}<g style="${c()}"><line x1="26" y1="50" x2="24" y2="56"/><line x1="36" y1="50" x2="34" y2="56"/><line x1="46" y1="50" x2="44" y2="56"/></g>`;
      const fog = `<g>${cloud}<g style="${c()}"><line x1="18" y1="56" x2="50" y2="56"/><line x1="14" y1="62" x2="46" y2="62"/></g></g>`;
      const snow = `${cloud}<g style="${c()}"><line x1="24" y1="50" x2="20" y2="60"/><line x1="24" y1="60" x2="20" y2="50"/><line x1="36" y1="50" x2="32" y2="60"/><line x1="36" y1="60" x2="32" y2="50"/><line x1="48" y1="50" x2="44" y2="60"/><line x1="48" y1="60" x2="44" y2="50"/></g>`;
      const sleet = `${cloud}<g style="${c()}"><line x1="24" y1="50" x2="20" y2="60"/><line x1="36" y1="50" x2="32" y2="60"/><line x1="48" y1="50" x2="44" y2="60"/></g><g style="${c()}"><line x1="28" y1="50" x2="24" y2="56"/><line x1="40" y1="50" x2="36" y2="56"/></g>`;
      const storm = `${cloud}<polyline points="28,48 36,48 30,60 42,60" style="${c()}"/>`;
      const cloudSun = `${sun}${cloud}`;
      const map = {sun,cloud,rain,drizzle,fog,snow,sleet,storm,'cloud-sun':cloudSun};
      return `<svg width="${s}" height="${s}" viewBox="0 0 62 62" aria-hidden="true">${map[kind]||sun}</svg>`;
    }

    function kToUnitDisplay(kC){ return unit==='imperial' ? Math.round(kC*9/5+32) : Math.round(kC); }

    function fmtHM(date){ return new Intl.DateTimeFormat('en-CA',{hour:'2-digit',minute:'2-digit',hour12:false,timeZone:tz}).format(date); }
    function fmtDay(date){ return new Intl.DateTimeFormat('en-CA',{weekday:'short', month:'short', day:'numeric', timeZone:tz}).format(date); }

    function setIcon(el, kind){ el.innerHTML = iconSVG(kind); }

    function setUpdated(ts){ $('#updated').textContent = `Updated ${new Intl.DateTimeFormat('en-CA',{hour:'numeric',minute:'2-digit', timeZone:tz}).format(ts)} ${city}`; }

    // ----- Time helpers: correctly parse Open-Meteo local strings (no offset) -----
    function parseLocalToUTC(str, offsetSeconds){
      // str "YYYY-MM-DDTHH:MM" is LOCAL to the requested tz (Toronto). Convert to an instant (UTC ms).
      const [d, t] = str.split('T');
      const [y,m,day] = d.split('-').map(Number);
      const [hh,mm] = t.split(':').map(Number);
      const localUTC = Date.UTC(y, m-1, day, hh, mm);
      return new Date(localUTC - offsetSeconds*1000); // subtract offset to get UTC instant
    }
    function nowUTC(){ return new Date(); }

    // Build API URL (Open-Meteo)
    function apiURL(){
      const base = 'https://api.open-meteo.com/v1/forecast';
      const params = new URLSearchParams({
        latitude: lat, longitude: lon,
        current: 'temperature_2m,apparent_temperature,is_day,weather_code,relative_humidity_2m,wind_speed_10m',
        hourly: 'temperature_2m,apparent_temperature,precipitation_probability,weather_code',
        daily: 'sunrise,sunset,uv_index_max',
        timezone: tz
      });
      return `${base}?${params.toString()}`;
    }

    let cache = null; // keep latest fetch

    async function fetchWeather(){
      const url = apiURL();
      const res = await fetch(url, {cache:'no-store'});
      const data = await res.json();
      cache = data;
      setUpdated(new Date());
      render(data);
    }

    function mapCodeToKind(code){ const entry = WMO[code]||['Weather','sun']; return entry[1]; }
    function mapCodeToText(code){ const entry = WMO[code]||['Weather','sun']; return entry[0]; }

    function render(d){
      // Current conditions
      const c = d.current;
      const code = c.weather_code; const kind = mapCodeToKind(code);
      setIcon($('#bigIcon'), kind);
      $('#temp').textContent = kToUnitDisplay(c.temperature_2m);
      $('#unit').textContent = unit==='imperial'?'°F':'°C';
      $('#desc').textContent = `${mapCodeToText(code)} • Feels ${kToUnitDisplay(c.apparent_temperature)}° • RH ${Math.round(c.relative_humidity_2m)}% • Wind ${Math.round(c.wind_speed_10m)} ${unit==='imperial'?'mph':'km/h'}`;

      // Hourly mini forecast (next 6 hours)
      const hs = d.hourly;
      const timesUTC = hs.time.map(t=> parseLocalToUTC(t, d.utc_offset_seconds));
      const now = nowUTC();
      let startIdx = timesUTC.findIndex(t=> t >= now);
      if(startIdx < 0) startIdx = 0;
      const n = 6; const html = [];
      for(let i=0;i<n;i++){
        const idx = Math.min(startIdx+i, hs.time.length-1);
        const tUTC = timesUTC[idx];
        const temp = kToUnitDisplay(hs.temperature_2m[idx]);
        const codeH = hs.weather_code[idx];
        const kindH = mapCodeToKind(codeH);
        html.push(`<div class="chip"><div class="t">${fmtHM(tUTC)}</div><div>${iconSVG(kindH,28)}</div><div class="v">${temp}°</div></div>`);
      }
      $('#mini').innerHTML = html.join('');

      // Daylight dial
      updateDial(d);
      $('#summary').textContent = `${fmtDay(now)} • UV max ${Math.round(d.daily.uv_index_max[0]??0)}`;
    }

    function updateDial(d){
      const now = nowUTC();
      // parse to UTC instants using offsetSeconds
      const srList = d.daily.sunrise.map(t=> parseLocalToUTC(t, d.utc_offset_seconds));
      const ssList = d.daily.sunset.map(t=> parseLocalToUTC(t, d.utc_offset_seconds));
      let sr = srList[0], ss = ssList[0];
      if(now > ssList[0] && srList[1]){ sr = srList[1]; ss = ssList[1]; }

      // geometry
      const cy=120, r=90; // SVG coords
      const startX = 20, endX = 200;
      const dayPath = `M${startX},${cy} A${r},${r} 0 0 1 ${endX},${cy} L ${endX},${cy+2} L ${startX},${cy+2} Z`;
      $('#dayFill').setAttribute('d', dayPath);

      let frac;
      if(now < sr){ // before sunrise → night, position on left
        const lastSS = ssList[0];
        const span = sr - lastSS; frac = (now - lastSS)/span; // 0..1 across night
        showMoon(true);
      } else if(now > ss){ // after sunset → night until next sunrise
        const nextSR = srList[1]||srList[0];
        const span = nextSR - ss; frac = (now - ss)/span; showMoon(true);
      } else { // day
        const span = ss - sr; frac = (now - sr)/span; showMoon(false);
      }
      frac = Math.min(1, Math.max(0, frac));

      const x = 20 + (180 * frac);
      const angle = Math.PI * (1 - frac);
      const y = cy - Math.sin(angle) * r;
      const target = (now >= sr && now <= ss) ? $('#sun') : $('#moon');
      target.setAttribute('cx', x.toFixed(1)); target.setAttribute('cy', y.toFixed(1));

      // labels in Toronto time
      $('#sunrise').textContent = `Sunrise ${fmtHM(sr)}`;
      $('#sunset').textContent = `Sunset ${fmtHM(ss)}`;
    }

    function showMoon(flag){ $('#moon').setAttribute('opacity', flag? '0.9':'0.0'); $('#sun').setAttribute('opacity', flag? '0.0':'1'); }

    // ticks along the base
    (function buildTicks(){
      const g = $('#ticks'); g.innerHTML='';
      for(let i=0;i<=6;i++){
        const x = 20 + i*(180/6); const y1=120, y2=116;
        const line = document.createElementNS('http://www.w3.org/2000/svg','line');
        line.setAttribute('x1',x); line.setAttribute('y1',y1); line.setAttribute('x2',x); line.setAttribute('y2',y2);
        line.setAttribute('stroke','rgba(255,255,255,.25)'); line.setAttribute('stroke-width','1');
        g.appendChild(line);
      }
    })();

    // Continuous updates
    fetchWeather();
    setInterval(()=>{ fetchWeather().catch(()=>{}); }, refreshMin*60*1000); // refresh weather
    setInterval(()=>{ if(cache) updateDial(cache); }, 60*1000); // move sun/moon smoothly each minute

    // Toggle °C/°F
    $('#toggleUnit').addEventListener('click',()=>{ unit = unit==='metric'?'imperial':'metric'; if(cache) render(cache); $('#toggleUnit').textContent = unit==='imperial'?'°F':'°C'; });
  })();
  </script>
</body>
</html>
